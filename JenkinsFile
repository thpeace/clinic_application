pipeline {
  agent any

  environment {
    APP_NAME        = "react-tailwind-app"
    DOCKER_IMAGE    = "react-tailwind-app:latest"
    BRANCH_NAME     = "master"
    REMOTE_HOST     = "10.10.0.154"
    REMOTE_USER     = "docker"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: BRANCH_NAME,
            url: 'https://github.com/thpeace/clinic_application.git',
            credentialsId: 'github-credentials'
      }
    }

    stage('Node Install & Build') {
      steps {
        sh 'npm install'
        sh 'npm run build'
      }
      post {
        success {
          archiveArtifacts artifacts: 'build/**', fingerprint: true
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv('SonarQube') {
          sh '''
            sonar-scanner \
              -Dsonar.projectKey=react_tailwind \
              -Dsonar.projectName=react_tailwind \
              -Dsonar.sources=src \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.login=$SONAR_AUTH_TOKEN || true
          '''
        }
      }
    }

    stage('Build Docker Image for React') {
      steps {
        // Use a production Dockerfile that serves React app via Nginx
        sh "docker build -t ${DOCKER_IMAGE} -f docker/Dockerfile.prod ."
      }
    }

    stage('Push Docker Image to Remote Server') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'remote-server-ssh-pass', usernameVariable: 'SSH_USER', passwordVariable: 'SSH_PASS')]) {
          sh '''
            set -e
            docker save ${DOCKER_IMAGE} -o reactapp.tar
            sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no reactapp.tar $SSH_USER@${REMOTE_HOST}:/home/docker/
            sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no $SSH_USER@${REMOTE_HOST} "
              docker load -i /home/docker/reactapp.tar &&
              docker rm -f reactapp || true &&
              docker run -d --name reactapp -p 80:80 ${DOCKER_IMAGE}
            "
          '''
        }
      }
    }

  }

  post {
    success { echo "✅ Pipeline completed successfully" }
    failure { echo "❌ Pipeline failed" }
  }
}